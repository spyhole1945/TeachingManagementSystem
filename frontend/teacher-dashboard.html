<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆä»ªè¡¨æ¿ - æ•™å­¦ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .navbar {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            padding: var(--spacing-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .dashboard-header {
            padding: var(--spacing-2xl) 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            margin-bottom: var(--spacing-2xl);
        }

        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            border-bottom: 2px solid rgba(148, 163, 184, 0.1);
        }

        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all var(--transition-base);
        }

        .tab.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .tab:hover:not(.active) {
            color: var(--text-secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .course-card {
            position: relative;
            overflow: hidden;
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .course-code {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-light);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .course-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .course-info {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: var(--spacing-md);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            padding: var(--spacing-2xl);
            position: relative;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="#" class="navbar-brand">ğŸ“š æ•™å­¦ç®¡ç†ç³»ç»Ÿ - æ•™å¸ˆç«¯</a>
            <div class="navbar-user">
                <span id="userName" class="text-secondary">åŠ è½½ä¸­...</span>
                <div class="user-avatar" id="userAvatar">ğŸ‘¨â€ğŸ«</div>
                <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="padding-top: var(--spacing-xl); padding-bottom: var(--spacing-2xl);">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 style="font-size: 2rem; margin-bottom: var(--spacing-sm);">
                æ¬¢è¿å›æ¥ï¼Œ<span id="fullName"></span>ï¼
            </h1>
            <p style="color: var(--text-muted);">å·¥å·ï¼š<span id="employeeNumber"></span> | éƒ¨é—¨ï¼š<span id="department"></span>
            </p>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-4 mb-3" id="statsContainer">
            <div class="stat-card">
                <div class="stat-value" id="coursesCount">0</div>
                <div class="stat-label">æˆè¯¾è¯¾ç¨‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="studentsCount">0</div>
                <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="assignmentsCount">0</div>
                <div class="stat-label">ä½œä¸šæ•°é‡</div>
            </div>
            <div class="stat-card" onclick="viewPendingGrades()" style="cursor: pointer;">
                <div class="stat-value" id="pendingGrades">0</div>
                <div class="stat-label">å¾…æ‰¹æ”¹</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('courses')">ğŸ“š æˆ‘çš„è¯¾ç¨‹</button>
            <button class="tab" onclick="switchTab('grading')">ğŸ“ ä½œä¸šæ‰¹æ”¹</button>
            <button class="tab" onclick="switchTab('students')">ğŸ‘¥ å­¦ç”Ÿç®¡ç†</button>
        </div>

        <!-- Courses Tab -->
        <div id="coursesTab" class="tab-content active">
            <div class="flex justify-between items-center mb-2">
                <h3>è¯¾ç¨‹åˆ—è¡¨</h3>
                <button class="btn btn-primary btn-sm" onclick="showAlert('åŠŸèƒ½å¼€å‘ä¸­', 'info')">åˆ›å»ºè¯¾ç¨‹</button>
            </div>
            <div id="coursesContainer" class="grid grid-cols-2"></div>
        </div>

        <!-- Grading Tab -->
        <div id="gradingTab" class="tab-content">
            <div class="card mb-2">
                <div class="form-group mb-0">
                    <label class="form-label">é€‰æ‹©è¯¾ç¨‹æŸ¥çœ‹ä½œä¸š</label>
                    <select class="form-select" id="courseSelect" onchange="loadCourseAssignments(this.value)">
                        <option value="">è¯·é€‰æ‹©è¯¾ç¨‹...</option>
                    </select>
                </div>
            </div>
            <div id="assignmentsListContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>è¯·å…ˆé€‰æ‹©è¯¾ç¨‹</p>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="studentsTab" class="tab-content">
            <div class="card">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>å­¦å·</th>
                                <th>å§“å</th>
                                <th>ä¸“ä¸š</th>
                                <th>å¹´çº§</th>
                                <th>è¯¾ç¨‹</th>
                                <th>æˆç»©</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="6" class="text-center">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Grading Modal -->
    <div id="gradingModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h2 id="gradingModalTitle">ä½œä¸šè¯„åˆ†</h2>
                <button class="btn btn-secondary btn-sm" onclick="closeGradingModal()">å…³é—­</button>
            </div>
            <div id="submissionContent" class="mb-2 p-2"
                style="background: rgba(0,0,0,0.2); border-radius: var(--radius-sm);">
                <!-- Submission content goes here -->
            </div>
            <form id="gradingForm" onsubmit="submitGrade(event)">
                <input type="hidden" id="submissionId">
                <div class="form-group">
                    <label class="form-label">åˆ†æ•° (0-100)</label>
                    <input type="number" class="form-input" id="gradeScore" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è¯„è¯­</label>
                    <textarea class="form-textarea" id="gradeFeedback" rows="3" placeholder="è¯·è¾“å…¥è¯„è¯­..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">æäº¤è¯„åˆ†</button>
            </form>
        </div>
    </div>

    <!-- Create Assignment Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h2>å‘å¸ƒæ–°ä½œä¸š</h2>
                <button class="btn btn-secondary btn-sm"
                    onclick="document.getElementById('assignmentModal').style.display='none'">å…³é—­</button>
            </div>
            <form id="createAssignmentForm" onsubmit="handleCreateAssignment(event)">
                <input type="hidden" id="assignmentCourseId">
                <div class="form-group">
                    <label class="form-label">ä½œä¸šæ ‡é¢˜</label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-textarea" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="datetime-local" class="form-input" name="dueDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ€»åˆ†</label>
                    <input type="number" class="form-input" name="totalPoints" value="100" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">å‘å¸ƒä½œä¸š</button>
            </form>
        </div>
    </div>

    <!-- Grade Import Modal -->
    <div id="gradeImportModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h2>æ‰¹é‡å½•å…¥æˆç»©</h2>
                <button class="btn btn-secondary btn-sm" onclick="closeGradeImportModal()">å…³é—­</button>
            </div>

            <div class="alert alert-info mb-2">
                <p>è¯·å…ˆä¸‹è½½æ¨¡æ¿ï¼Œå¡«å†™åå†ä¸Šä¼ ã€‚</p>
                <button class="btn btn-secondary btn-sm mt-1" onclick="downloadTemplate()">â¬‡ï¸ ä¸‹è½½Excelæ¨¡æ¿</button>
            </div>

            <form id="gradeImportForm" onsubmit="handleBatchUpload(event)">
                <input type="hidden" id="importCourseId">
                <div class="form-group">
                    <label class="form-label">ä¸Šä¼ å·²å¡«å†™çš„Excelæ–‡ä»¶</label>
                    <input type="file" name="file" class="form-input" accept=".xlsx" required>
                </div>
                <div id="uploadResult" class="mb-2" style="display:none;"></div>
                <button type="submit" class="btn btn-primary w-full">å¼€å§‹å¯¼å…¥</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // ... (existing code) ...

        // Grade Import Functions
        function openGradeImportModal(courseId) {
            document.getElementById('importCourseId').value = courseId;
            document.getElementById('gradeImportModal').style.display = 'flex';
            document.getElementById('uploadResult').style.display = 'none';
            document.getElementById('gradeImportForm').reset();
        }

        function closeGradeImportModal() {
            document.getElementById('gradeImportModal').style.display = 'none';
        }

        async function downloadTemplate() {
            const currentCourseId = document.getElementById('importCourseId').value;
            if (!currentCourseId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯¾ç¨‹');
                return;
            }
            try {
                // Use a direct temporary link approach or api.js if it supports blob
                const token = localStorage.getItem('tms_token');
                if (!token) throw new Error('Not logged in');

                // Add course_id to pre-fill template
                const response = await fetch(`${API_BASE_URL}/grades/template?course_id=${currentCourseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `grade_template_course_${currentCourseId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                alert('æ¨¡æ¿ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function handleBatchUpload(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const courseId = document.getElementById('importCourseId').value;
            const resultDiv = document.getElementById('uploadResult');

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'æ­£åœ¨ä¸Šä¼ å¤„ç†ä¸­...';
            resultDiv.className = 'alert alert-info mb-2';

            try {
                const response = await fetch(`${API_BASE_URL}/grades/batch/${courseId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${api.token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.detail || 'Upload failed');

                let resultHtml = `<p><strong>å¯¼å…¥å®Œæˆ</strong></p>`;
                resultHtml += `<p class="text-success">æˆåŠŸ: ${data.success_count} æ¡</p>`;

                if (data.failure_count > 0) {
                    resultHtml += `<p class="text-danger">å¤±è´¥: ${data.failure_count} æ¡</p>`;
                    resultHtml += `<ul class="text-sm mt-1" style="max-height: 100px; overflow-y: auto;">`;
                    data.errors.forEach(err => {
                        resultHtml += `<li>${err}</li>`;
                    });
                    resultHtml += `</ul>`;
                    resultDiv.className = 'alert alert-warning mb-2';
                } else {
                    resultDiv.className = 'alert alert-success mb-2';
                    setTimeout(() => {
                        closeGradeImportModal();
                        showAlert('å…¨éƒ¨å¯¼å…¥æˆåŠŸï¼', 'success');
                    }, 2000);
                }

                resultDiv.innerHTML = resultHtml;

            } catch (error) {
                resultDiv.className = 'alert alert-error mb-2';
                resultDiv.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
            }
        }

        // ... (rest of existing code)
        // Auth Check
        if (!checkAuth() || !api.user) {
            window.location.href = 'login.html';
        }

        if (api.user.role !== 'teacher' && api.user.role !== 'admin') {
            showAlert('æ‚¨ä¸æ˜¯æ•™å¸ˆè´¦å·', 'error');
            setTimeout(() => window.location.href = 'login.html', 1500);
        }

        let teacherId = null;
        let myCourses = [];

        // Init
        async function init() {
            document.getElementById('userName').textContent = api.user.username;
            document.getElementById('fullName').textContent = api.user.full_name;

            try {
                // Get teacher profile
                // Assuming we have a way to get teacher ID from user ID or a teacher endpoint
                // For now, simpler approach: fetch all teachers and find match
                // In production, /users/me/teacher-profile would be better

                // Let's use a workaround if we don't have a direct endpoint
                // Or maybe api.user has teacher_profile if we logged in via a smart endpoint
                // But the auth login returns user object. 

                // Let's try to fetch courses directly if the API supports it
                // Actually, api.js has getTeacherCourses(teacherId)
                // We need to find teacherId first.

                // Hack: In our mock data, teacher ID usually matches user ID order or we can search
                // Proper way: API should provide this. 
                // Let's assume for this demo we can get courses by logged in user context or 
                // we iterate to find our teacher ID.

                // Try to get current user details which might include profile
                // If not, we'll just try ID 1 for prof_zhang as a fallback for the demo
                const teachers = await api.request('/teachers/');
                const me = teachers.find(t => t.user_id === api.user.id);

                if (me) {
                    teacherId = me.id;
                    document.getElementById('employeeNumber').textContent = me.employee_number;
                    document.getElementById('department').textContent = me.department;
                } else {
                    console.error('Teacher profile not found');
                    return;
                }

                await loadCourses();
                await loadStats();

            } catch (error) {
                console.error('Init error:', error);
                showAlert('åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // Load Courses
        async function loadCourses() {
            try {
                myCourses = await api.getTeacherCourses(teacherId);
                const container = document.getElementById('coursesContainer');
                const select = document.getElementById('courseSelect');

                document.getElementById('coursesCount').textContent = myCourses.length;

                // Populate course list
                container.innerHTML = myCourses.map(course => `
                    <div class="card course-card">
                        <div class="course-header">
                            <div>
                                <div class="course-code">${course.course_code}</div>
                                <h3 class="course-title">${course.name}</h3>
                            </div>
                        </div>
                        <div class="course-info">
                            <span>ğŸ“… ${course.semester}</span>
                            <span>ğŸ‘¥ ${course.capacity}äººä¸Šé™</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-primary btn-sm" onclick="showCreateAssignmentModal(${course.id})">å‘å¸ƒä½œä¸š</button>
                            <button class="btn btn-secondary btn-sm" onclick="loadCourseAssignments(${course.id}); switchTab('grading')">æ‰¹æ”¹ä½œä¸š</button>
                            <button class="btn btn-info btn-sm" onclick="openGradeImportModal(${course.id})">æˆç»©å½•å…¥</button>
                        </div>
                    </div>
                `).join('');

                // Populate select
                select.innerHTML = '<option value="">è¯·é€‰æ‹©è¯¾ç¨‹...</option>' +
                    myCourses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            } catch (error) {
                console.error('Load courses error:', error);
            }
        }

        // Stats Logic
        async function loadStats() {
            try {
                let totalStudents = 0;
                let totalAssignments = 0;
                let pendingGrades = 0;

                for (const course of myCourses) {
                    // Students
                    try {
                        // Use the new endpoint created in Step 759
                        const enrollments = await api.request(`/enrollments/course/${course.id}`);
                        totalStudents += enrollments.length;
                    } catch (e) {
                        console.error('Stats: fetch enrollments failed', e);
                    }

                    // Assignments
                    try {
                        const assignments = await api.request(`/assignments/course/${course.id}`);
                        totalAssignments += assignments.length;

                        // Pending Grades
                        for (const ass of assignments) {
                            try {
                                const ungraded = await api.getAssignmentSubmissions(ass.id, true);
                                pendingGrades += ungraded.length;
                            } catch (e) {
                                console.error('Stats: fetch submissions failed', e);
                            }
                        }
                    } catch (e) {
                        console.error('Stats: fetch assignments failed', e);
                    }
                }

                document.getElementById('studentsCount').textContent = totalStudents;
                document.getElementById('assignmentsCount').textContent = totalAssignments;
                document.getElementById('pendingGrades').textContent = pendingGrades;

            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        // Feature: Assignments Management
        async function loadCourseAssignments(courseId) {
            if (!courseId) return;
            const container = document.getElementById('assignmentsListContainer');
            container.innerHTML = '<div class="text-center">åŠ è½½ä¸­...</div>';

            // Set select value if called externally
            document.getElementById('courseSelect').value = courseId;

            try {
                const assignments = await api.request(`/assignments/course/${courseId}`);

                if (assignments.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>è¯¥è¯¾ç¨‹æš‚æ— ä½œä¸š</p></div>';
                    return;
                }

                let html = '';
                for (const assignment of assignments) {
                    // Get submissions count
                    const submissions = await api.getAssignmentSubmissions(assignment.id);
                    const ungraded = submissions.filter(s => !s.score && s.score !== 0);

                    html += `
                        <div class="card mb-2">
                             <div class="flex justify-between items-start">
                                <div>
                                    <h4 style="font-weight: 600;">${assignment.title}</h4>
                                    <p class="text-muted text-sm">${assignment.description || 'æ— æè¿°'}</p>
                                    <div class="text-sm mt-1">
                                        <span>ğŸ“… æˆªæ­¢: ${new Date(assignment.due_date).toLocaleString()}</span>
                                        <span class="ml-2">ğŸ“Š æ€»åˆ†: ${assignment.total_points}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="mb-1">
                                        <span class="badge ${ungraded.length > 0 ? 'badge-warning' : 'badge-success'}">
                                            ${ungraded.length} å¾…æ‰¹æ”¹ / ${submissions.length} å·²æäº¤
                                        </span>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="expandGradingArea(${assignment.id})">
                                        å±•å¼€æ‰¹æ”¹
                                    </button>
                                </div>
                             </div>
                             <div id="grading-area-${assignment.id}" style="display: none; margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                                 <!-- Grading list will be loaded here -->
                             </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function expandGradingArea(assignmentId) {
            const area = document.getElementById(`grading-area-${assignmentId}`);
            if (area.style.display === 'block') {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'block';
            area.innerHTML = 'åŠ è½½æäº¤è®°å½•...';

            try {
                const submissions = await api.getAssignmentSubmissions(assignmentId);
                if (submissions.length === 0) {
                    area.innerHTML = '<p class="text-center text-muted">æš‚æ— æäº¤è®°å½•</p>';
                    return;
                }

                // Get student info for submissions
                // In a real app, we should batch fetch students, but here we loop
                const listHtmlPromises = submissions.map(async sub => {
                    let studentName = `å­¦ç”Ÿ #${sub.student_id}`;
                    try {
                        const student = await api.getStudent(sub.student_id);
                        // User info is inside student object's user relation usually, but API returns student info
                        // Let's assume we can get user info. Actually getStudent returns student profile.
                        // Maybe we need another call to get user details?
                        // The student endpoint returns user_id. We might need /users/{id} or similar.
                        // For simplicity, let's just show ID if name fetch is hard, or generic name.
                        // Actually, getStudents returns list with user_id.
                        // Let's just use student_number if available from getStudent result
                        studentName = student.student_number || `S${sub.student_id}`;
                    } catch (e) { }

                    const isGraded = sub.score !== null && sub.score !== undefined;

                    return `
                        <div class="flex justify-between items-center p-2 mb-1" style="background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <div>
                                <div><strong>${studentName}</strong></div>
                                <div class="text-sm text-muted">æäº¤æ—¶é—´: ${new Date(sub.submitted_at).toLocaleString()}</div>
                                ${sub.file_path ? `
                                    <button class="btn btn-sm btn-info mt-1" onclick="downloadSubmissionFile(${sub.id}, '${sub.file_path.split('/').pop()}')">
                                        ğŸ“¥ ä¸‹è½½é™„ä»¶
                                    </button>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                ${isGraded
                            ? `<div><span class="badge badge-success">${sub.score}åˆ†</span></div>`
                            : `<button class="btn btn-primary btn-sm" onclick="openGradingModal(${sub.id}, ${sub.score || 0}, '${sub.content || ''}')">è¯„åˆ†</button>`
                        }
                            </div>
                        </div>
                     `;
                });

                const listHtml = await Promise.all(listHtmlPromises);
                area.innerHTML = listHtml.join('');

            } catch (error) {
                area.innerHTML = 'åŠ è½½å¤±è´¥';
            }
        }

        // Grading Actions
        let currentSubmissionId = null;

        function openGradingModal(subId, currentScore, content) {
            currentSubmissionId = subId;
            document.getElementById('submissionId').value = subId;
            document.getElementById('gradeScore').value = currentScore || '';
            document.getElementById('gradeFeedback').value = '';
            document.getElementById('submissionContent').innerHTML = `<p><strong>ä½œä¸šå†…å®¹:</strong></p><p>${content || 'æ— æ–‡æœ¬å†…å®¹'}</p>`;
            document.getElementById('gradingModal').style.display = 'flex';
        }

        function closeGradingModal() {
            document.getElementById('gradingModal').style.display = 'none';
        }

        async function submitGrade(event) {
            event.preventDefault();
            const score = parseFloat(document.getElementById('gradeScore').value);
            const feedback = document.getElementById('gradeFeedback').value;

            try {
                await api.gradeSubmission(currentSubmissionId, score, feedback);
                showAlert('è¯„åˆ†æˆåŠŸ', 'success');
                closeGradingModal();
                // Refresh
                const courseId = document.getElementById('courseSelect').value;
                if (courseId) loadCourseAssignments(courseId);
                loadStats(); // Update pending count
            } catch (error) {
                showAlert('è¯„åˆ†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Assignment Creation
        function showCreateAssignmentModal(courseId) {
            document.getElementById('assignmentCourseId').value = courseId;
            document.getElementById('assignmentModal').style.display = 'flex';
        }

        async function handleCreateAssignment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                course_id: parseInt(document.getElementById('assignmentCourseId').value),
                title: formData.get('title'),
                description: formData.get('description'),
                due_date: formData.get('dueDate'),
                total_points: parseInt(formData.get('totalPoints'))
            };

            try {
                await api.createAssignment(data);
                showAlert('å‘å¸ƒæˆåŠŸ', 'success');
                document.getElementById('assignmentModal').style.display = 'none';
                loadStats();
                loadCourses();
            } catch (error) {
                showAlert('å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // File Download
        async function downloadSubmissionFile(submissionId, filename) {
            try {
                const response = await fetch(`${API_BASE_URL}/assignments/submissions/${submissionId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${api.token}`
                    }
                });

                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'submission_file';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                showAlert('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Helpers
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Find tab button (simplest way: match text or use strict id logic)
            // Here we just find buttons with specific onclick
            const buttons = document.querySelectorAll('.tab');
            for (let b of buttons) {
                if (b.getAttribute('onclick').includes(tabName)) {
                    b.classList.add('active');
                }
            }

            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showAlert(msg, type) {
            // Reuse implementation from student dashboard or simple alert
            const div = document.createElement('div');
            div.className = `alert alert-${type} fade-in`;
            div.textContent = msg;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.right = '20px';
            div.style.zIndex = '9999';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function logout() {
            api.logout();
            window.location.href = 'login.html';
        }

        // Run
        init();

        // Expose function for onclick
        window.viewPendingGrades = function () {
            switchTab('grading');
            showAlert('è¯·é€‰æ‹©è¯¾ç¨‹ä»¥å¼€å§‹æ‰¹æ”¹', 'info');
        };
    </script>
</body>

</html>